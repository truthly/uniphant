<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>🦄🐘uniphant playground</title>
<style>
.error {
  background-color: #ffaaaa;
}
.pre {
    white-space: pre;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    display: block;
    unicode-bidi: embed
}
#signed-in-div {
  float:right;
  margin-right:10px;
  clear:both;
}
</style>
</head>
<body>
<div id="signed-in-div" class="pre"></div>
<h1 class="pre">🦄🐘uniphant</h1>
<input placeholder="username" type="text" id="username" autofocus required />
<input placeholder="device-name" type="text" id="device-name" required />
<button id="sign-up" disabled>Sign up</button>
<button id="sign-in" disabled>Sign in</button>
<button id="sign-out" disabled>Sign out</button>
<button id="add-a-new-key" disabled>Add a new key on same device</button>
<button id="add-a-new-key-other-device" disabled>Add a new key on other device</button>
<input placeholder="challenge" type="text" id="challenge" />
<button id="generate-key-from-challenge">Generate key from challenge</button>
<div id="qr-code"></div>
<div id="challenge-url" class="pre"></div>
</div><div class="pre" id="log"></div>
<script type="text/javascript" src="qrcode.min.js"></script>
<script>

  // This file is based on: https://webauthn.io/dist/js/webauthn.js

  function buffer_decode(value) {
    let new_value = (value + '==='.slice((value.length + 3) % 4))
    .replace(/-/g, '+')
    .replace(/_/g, '/');
    return Uint8Array.from(atob(new_value), c => c.charCodeAt(0));
  }

  // Encode an ArrayBuffer into a base64url string.
  // Taken from: https://gist.github.com/Deliaz/e89e9a014fea1ec47657d1aac3baa83c
  function buffer_encode(buffer) {
    let binary = '';
    let bytes = new Uint8Array(buffer);
    let len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary)
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=/g, "");
  }

  function status(response) {
    if (response.status >= 200 && response.status < 300) {
      return Promise.resolve(response)
    } else {
      return Promise.reject(new Error(response.statusText))
    }
  }

  function json(response) {
    return response.json()
  }

  function sign_up() {
    if (document.getElementById("username").value === "") {
      document.getElementById("log").innerHTML += "please enter a username\n";
      document.getElementById("username").focus();
      return;
    }
    if (document.getElementById("device-name").value === "") {
      document.getElementById("log").innerHTML += "please enter a device_name\n";
      document.getElementById("device-name").focus();
      return;
    }
    document.getElementById("log").innerHTML += "POST /api/rpc/sign_up\n";
    fetch("/api/rpc/sign_up", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "username" : document.getElementById("username").value
      })
    }).then(status).then(json).then(function(ret) {
      document.getElementById("log").innerHTML += "POST /api/rpc/sign_up ok\n";
      if (ret === true) {
        document.getElementById("log").innerHTML += `✅ signed up\n`;
      } else {
        document.getElementById("log").innerHTML += "❌ sign up failed\n";
      }
      is_signed_in();
      init_credential();
    }).catch(function(error) {
      document.getElementById("log").innerHTML += `POST /api/rpc/sign_up error: ${error}\n`;
    });
  }

  function add_new_key_other_device() {
    if (document.getElementById("device-name").value === "") {
      document.getElementById("log").innerHTML += "please enter a device_name\n";
      document.getElementById("device-name").focus();
      return;
    }
    document.getElementById("log").innerHTML += "POST /api/rpc/init_credential\n";
    fetch("/api/rpc/init_credential", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "device_name" : document.getElementById("device-name").value
      })
    }).then(status).then(json).then(function(credential_creation_options) {
      document.getElementById("log").innerHTML += "POST /api/rpc/init_credential ok\n";
      let secret_challenge_url = window.location.origin + window.location.pathname + "?challenge=" + credential_creation_options.publicKey.challenge;
      document.getElementById("challenge-url").innerHTML = secret_challenge_url;
      new QRCode(document.getElementById("qr-code"), {
        text: secret_challenge_url,
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
    }).catch(function(error) {
      document.getElementById("log").innerHTML += `POST /api/rpc/init_credential error: ${error}\n`;
    });
  }

  function init_credential() {
    if (document.getElementById("device-name").value === "") {
      document.getElementById("log").innerHTML += "please enter a device_name\n";
      document.getElementById("device-name").focus();
      return;
    }
    document.getElementById("log").innerHTML += "POST /api/rpc/init_credential\n";
    fetch("/api/rpc/init_credential", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "device_name" : document.getElementById("device-name").value
      })
    }).then(status).then(json).then(function(credential_creation_options) {
      create_credential(credential_creation_options);
    }).catch(function(error) {
      document.getElementById("log").innerHTML += `POST /api/rpc/init_credential error: ${error}\n`;
    });
  }

  function get_credential_creation_options(challenge) {
    document.getElementById("log").innerHTML += "POST /api/rpc/get_credential_creation_options\n";
    fetch("/api/rpc/get_credential_creation_options", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "challenge" : challenge
      })
    }).then(status).then(json).then(function(credential_creation_options) {
      document.getElementById("log").innerHTML += "POST /api/rpc/get_credential_creation_options ok\n";
      create_credential(credential_creation_options);
    }).catch(function(error) {
      document.getElementById("log").innerHTML += `POST /api/rpc/get_credential_creation_options error: ${error}\n`;
    });
  }

  function create_credential(credential_creation_options) {
    // base64 values needs to be decoded to Uint8Arrays:
    credential_creation_options.publicKey.challenge = buffer_decode(credential_creation_options.publicKey.challenge);
    credential_creation_options.publicKey.user.id = buffer_decode(credential_creation_options.publicKey.user.id);
    if (credential_creation_options.publicKey.excludeCredentials) {
      for (let i = 0; i < credential_creation_options.publicKey.excludeCredentials.length; i++) {
        credential_creation_options.publicKey.excludeCredentials[i].id = buffer_decode(credential_creation_options.publicKey.excludeCredentials[i].id);
      }
    }
    document.getElementById("log").innerHTML += "navigator.credentials.create()\n";
    navigator.credentials.create(credential_creation_options).then(function (new_credential) {
      document.getElementById("log").innerHTML += "navigator.credentials.create() ok\n";
      store_credential(new_credential, credential_creation_options.publicKey.challenge);
    }).catch(function (err) {
      document.getElementById("log").innerHTML += "navigator.credentials.create() error\n";
    });
  }

  function store_credential(new_credential) {
    let attestation_object = new Uint8Array(new_credential.response.attestationObject);
    let client_data_json = new Uint8Array(new_credential.response.clientDataJSON);
    let raw_id = new Uint8Array(new_credential.rawId);
    document.getElementById("log").innerHTML += "POST /api/rpc/store_credential\n";
    fetch("/api/rpc/store_credential", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "credential_id" : buffer_encode(raw_id),
        "credential_type" : new_credential.type,
        "attestation_object" : buffer_encode(attestation_object),
        "client_data_json" : buffer_encode(client_data_json)
      })
    }).then(status).then(json).then(function(status) {
      if (status) {
        document.getElementById("log").innerHTML += "POST /api/rpc/store_credential ok\n";
        document.getElementById("username").value = "";
        document.getElementById("device-name").value = "";
        document.getElementById("log").innerHTML += "✅ credential created successfully\n";
      } else {
        document.getElementById("log").innerHTML += "POST /api/rpc/store_credential error\n";
      }
    }).catch(function (err) {
      console.log(err);
      document.getElementById("log").innerHTML += "POST /api/rpc/store_credential error\n";
    });
  }

  function sign_in() {
    document.getElementById("log").innerHTML += "POST /api/rpc/get_credentials\n";
    fetch("/api/rpc/get_credentials", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({})
    }).then(status).then(json).then(function(make_assertion_options) {
      document.getElementById("log").innerHTML += "POST /api/rpc/get_credentials ok\n";
      make_assertion_options.publicKey.challenge = buffer_decode(make_assertion_options.publicKey.challenge);
      console.log(make_assertion_options.publicKey);
      if (make_assertion_options.publicKey.allowCredentials) {
        make_assertion_options.publicKey.allowCredentials.forEach(function (list_item) {
          list_item.id = buffer_decode(list_item.id)
        });
      }
      document.getElementById("log").innerHTML += "navigator.credentials.get()\n";
      navigator.credentials.get({
        publicKey: make_assertion_options.publicKey
      })
      .then(function (asserted_credential) {
        document.getElementById("log").innerHTML += "navigator.credentials.get() ok\n";
        verify_assertion(asserted_credential);
      }).catch(function (err) {
        console.log(err);
        document.getElementById("log").innerHTML += "navigator.credentials.get() error\n";
      });
    }).catch(function (err) {
      console.log(err);
      document.getElementById("log").innerHTML += "POST /api/rpc/get_credentials error\n";
    });
  }

  function verify_assertion(asserted_credential) {
    let authenticator_data = new Uint8Array(asserted_credential.response.authenticatorData);
    let client_data_json = new Uint8Array(asserted_credential.response.clientDataJSON);
    let credential_raw_id = new Uint8Array(asserted_credential.rawId);
    let signature = new Uint8Array(asserted_credential.response.signature);
    let user_handle = new Uint8Array(asserted_credential.response.userHandle);
    document.getElementById("log").innerHTML += "POST /api/rpc/verify_assertion\n";
    fetch("/api/rpc/verify_assertion", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "credential_id" : buffer_encode(credential_raw_id),
        "credential_type" : asserted_credential.type,
        "authenticator_data" : buffer_encode(authenticator_data),
        "client_data_json" : buffer_encode(client_data_json),
        "signature" : buffer_encode(signature),
        "user_handle" : buffer_encode(user_handle)
      })
    }).then(status).then(json).then(function(ret) {
      document.getElementById("log").innerHTML += "POST /api/rpc/verify_assertion ok\n";
      if (ret === true) {
        document.getElementById("log").innerHTML += `✅ signed in\n`;
      } else {
        document.getElementById("log").innerHTML += "❌ sign in failed\n";
      }
      is_signed_in();
    }).catch(function (err) {
      document.getElementById("log").innerHTML += "POST /api/rpc/verify_assertion error\n";
    });
  }

  function is_signed_in() {
    document.getElementById("log").innerHTML += "POST /api/rpc/is_signed_in\n";
    fetch("/api/rpc/is_signed_in", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({})
    }).then(status).then(json).then(function(username) {
      document.getElementById("log").innerHTML += "POST /api/rpc/is_signed_in ok\n";
      if (username === null) {
        document.getElementById("signed-in-div").innerHTML = "";
        document.getElementById("sign-up").disabled = false;
        document.getElementById("sign-in").disabled = false;
        document.getElementById("sign-out").disabled = true;
        document.getElementById("add-a-new-key").disabled = true;
        document.getElementById("add-a-new-key-other-device").disabled = true;
      } else {
        document.getElementById("signed-in-div").innerHTML = `✅ signed in as ${username}`;
        document.getElementById("sign-up").disabled = true;
        document.getElementById("sign-in").disabled = true;
        document.getElementById("sign-out").disabled = false;
        document.getElementById("add-a-new-key").disabled = false;
        document.getElementById("add-a-new-key-other-device").disabled = false;
      }
    }).catch(function(error) {
      document.getElementById("log").innerHTML += `POST /api/rpc/is_signed_in error: ${error}\n`;
    });
  }

  function sign_out() {
    document.getElementById("log").innerHTML += "POST /api/rpc/sign_out\n";
    fetch("/api/rpc/sign_out", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({})
    }).then(status).then(json).then(function(ok) {
      document.getElementById("log").innerHTML += "POST /api/rpc/sign_out ok\n";
      is_signed_in();
    }).catch(function (err) {
      console.log(err);
      document.getElementById("log").innerHTML += "POST /api/rpc/sign_out error\n";
    });
  }

  function generate_key_from_challenge() {
    if (document.getElementById("challenge").value === "") {
      document.getElementById("log").innerHTML += "please enter the challenge\n";
      document.getElementById("challenge").focus();
      return;
    }
    let challenge = document.getElementById("challenge").value;
    get_credential_creation_options(challenge);
    is_signed_in();
  }

  function main() {
    is_signed_in();
    let challenge = new URLSearchParams(document.location.search).get("challenge");
    if (challenge) {
      window.history.replaceState(null, null, window.location.pathname);
      document.getElementById("challenge").value = challenge;
      document.getElementById("generate-key-from-challenge").focus();
      document.getElementById("log").innerHTML += "challenge loaded, proceed by clicking [Generate key from challenge]\n";
    }
  }

  document.getElementById("sign-up").addEventListener("click", sign_up);
  document.getElementById("sign-in").addEventListener("click", sign_in);
  document.getElementById("sign-out").addEventListener("click", sign_out);
  document.getElementById("add-a-new-key").addEventListener("click", init_credential);
  document.getElementById("add-a-new-key-other-device").addEventListener("click", add_new_key_other_device);
  document.getElementById("generate-key-from-challenge").addEventListener("click", generate_key_from_challenge);
  document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>